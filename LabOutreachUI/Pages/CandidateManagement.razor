@page "/candidates"
@attribute [Authorize(Policy = "RandomDrugScreen")]
@using MigraDocCore.DocumentObjectModel
@using MigraDocCore.Rendering
@inject IRandomDrugScreenService RdsService
@inject DictionaryService DictionaryService
@inject IJSRuntime JSRuntime
@inject LabBilling.Core.DataAccess.IAppEnvironment AppEnvironment
@inject LabBilling.Core.UnitOfWork.IUnitOfWork UnitOfWork
@inject NavigationManager NavigationManager

<PageTitle>Candidate Management - Random Drug Screen</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="mb-0">Candidate Management</h3>
    <a href="/help/user-guide#candidate-management" class="btn btn-sm btn-outline-info" title="View Help">
    <span class="oi oi-book"></span> Help
    </a>
</div>

@if (!string.IsNullOrEmpty(errorMessage))
{
    <div class="alert alert-danger alert-dismissible py-2 mb-2">
 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        <small><strong>Error:</strong> @errorMessage</small>
  </div>
}

<ClientSelectionPanel Clients="@clients"
    SelectedClient="@selectedClient"
      Shifts="@shifts"
  SelectedShift="@selectedShift"
          ShowDeleted="@showDeleted"
   OnClientSelected="@OnClientSelected"
     OnClearSelection="@ClearClientSelection"
  OnShiftChanged="@OnShiftChanged"
          OnShowDeletedChanged="@OnShowDeletedChanged"
            OnAddNew="@ShowAddCandidateModal" />

<RandomSelectionPanel SelectedClient="@selectedClient"
         Shifts="@shifts"
   IsExpanded="@showSelectionPanel"
     SelectionShift="@selectionShift"
  SelectionCount="@selectionCount"
          AvailableCount="@selectionAvailableCount"
   IsProcessing="@isSelectionProcessing"
         CanPerformSelection="@CanPerformSelection()"
            ValidationMessage="@selectionValidationMessage"
          ErrorMessage="@selectionErrorMessage"
         OnTogglePanel="@ToggleSelectionPanel"
      OnShiftChanged="@OnSelectionShiftChanged"
  OnSelectionCountChanged="@OnSelectionCountChanged"
               OnPerformSelection="@PerformSelection" />

<SelectionResultsPanel SelectedCandidates="@selectedRandomCandidates"
           OnExport="@ExportSelectionResults"
         OnClear="@ClearSelectionResults" />

<ReportsPanel SelectedClient="@selectedClient"
   IsExpanded="@showReportsPanel"
      SelectedReportType="@selectedReportType"
 DaysSinceLastTest="@daysSinceLastTest"
      IsProcessing="@isReportLoading"
 ErrorMessage="@reportErrorMessage"
    PreviewData="@reportData"
              SummaryStats="@summaryStats"
 OnTogglePanel="@ToggleReportsPanel"
     OnReportTypeChanged="@OnReportTypeChanged"
     OnDaysChanged="@OnDaysChanged"
     OnExportCsv="@ExportReportToCsv"
              OnGeneratePdf="@GenerateReportPdf" />

<CandidateListTable Candidates="@candidates"
 SelectedClient="@selectedClient"
          IsLoading="@isLoading"
   OnEdit="@ShowEditCandidateModal"
    OnDelete="@ShowDeleteConfirmation"
      OnRestore="@RestoreCandidate" />

<CandidateModal IsVisible="@showModal"
          Candidate="@editingCandidate"
            Clients="@clients"
     IsProcessing="@isSaving"
         ErrorMessage="@errorMessage"
  OnSave="@SaveCandidate"
   OnCancel="@CloseModal" />

<DeleteConfirmationModal IsVisible="@showDeleteConfirm"
           CandidateName="@(candidateToDelete?.Name ?? "")"
     IsProcessing="@isSaving"
 OnConfirm="@ConfirmDelete"
          OnCancel="@CloseDeleteConfirmation" />

@code {
    // State fields
    private List<RandomDrugScreenPerson> candidates = new();
 private List<Client> clients = new();
    private List<string> shifts = new();

  private string selectedClient = "";
    private string selectedShift = "";
  private bool showDeleted = false;
    private bool isLoading = true;
  private bool isSaving = false;

  private bool showModal = false;
    private bool showDeleteConfirm = false;
    private RandomDrugScreenPerson? editingCandidate;
    private RandomDrugScreenPerson? candidateToDelete;
    private string? errorMessage;

    // Random Selection fields
    private bool showSelectionPanel = false;
    private string selectionShift = "";
    private int selectionCount = 1;
    private int selectionAvailableCount = 0;
    private bool isSelectionProcessing = false;
    private string? selectionValidationMessage;
    private string? selectionErrorMessage;
    private List<RandomDrugScreenPerson>? selectedRandomCandidates;

    // Reports fields
    private bool showReportsPanel = false;
    private string selectedReportType = "";
    private int daysSinceLastTest = 30;
    private bool isReportLoading = false;
    private string? reportErrorMessage;
    private List<RandomDrugScreenPerson>? reportData;
    private ReportsPanel.ClientSummaryStats summaryStats = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
  await LoadClients();

            var uri = new Uri(NavigationManager.Uri);
            var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
  var clientParam = query["client"];

   if (!string.IsNullOrEmpty(clientParam))
            {
     var client = clients.FirstOrDefault(c => c.ClientMnem == clientParam);
     if (client != null)
      {
   await OnClientSelected(client);
      }
            }
        }
        catch (Exception ex)
        {
   errorMessage = $"Error loading data: {ex.Message}";
         Console.WriteLine(ex.ToString());
    }
        finally
    {
            isLoading = false;
        }
    }

    // Data loading methods
    private async Task LoadClients()
{
        try
        {
        clients = await DictionaryService.GetAllClientsAsync(UnitOfWork, false);
   }
     catch (Exception ex)
      {
   Console.WriteLine($"Error loading clients: {ex.Message}");
         clients = new List<Client>();
    }
    }

    private async Task LoadShifts()
    {
        try
        {
          if (!string.IsNullOrEmpty(selectedClient))
            {
       shifts = await RdsService.GetDistinctShiftsAsync(selectedClient);
            }
            else
            {
                shifts = await RdsService.GetDistinctShiftsAsync();
       }
  }
        catch (Exception ex)
        {
     Console.WriteLine($"Error loading shifts: {ex.Message}");
            shifts = new List<string>();
  }
    }

    private async Task LoadCandidates()
    {
        isLoading = true;
        try
        {
       if (!string.IsNullOrEmpty(selectedClient))
     {
                if (!string.IsNullOrEmpty(selectedShift))
{
     candidates = await RdsService.GetCandidatesByClientAsync(selectedClient, showDeleted);
       candidates = candidates.Where(c => c.Shift == selectedShift).ToList();
         }
         else
         {
            candidates = await RdsService.GetCandidatesByClientAsync(selectedClient, showDeleted);
                }
          }
            else
            {
       candidates = await RdsService.GetAllCandidatesAsync(showDeleted);
     }
        }
     catch (Exception ex)
        {
            errorMessage = $"Error loading candidates: {ex.Message}";
         Console.WriteLine(ex.ToString());
     candidates = new List<RandomDrugScreenPerson>();
        }
        finally
        {
     isLoading = false;
     }
  }

    // Client selection handlers
    private async Task OnClientSelected(Client client)
    {
        selectedClient = client?.ClientMnem ?? "";
   selectedShift = "";
     await LoadShifts();
await LoadCandidates();
        await UpdateSelectionAvailableCount();
    }

private async Task ClearClientSelection()
 {
        selectedClient = "";
    selectedShift = "";
        candidates = new List<RandomDrugScreenPerson>();
        shifts = new List<string>();
      selectionAvailableCount = 0;
    selectedRandomCandidates = null;

        StateHasChanged();
        await Task.CompletedTask;
    }

  private async Task OnShiftChanged(string newShift)
    {
        selectedShift = newShift;
      await LoadCandidates();
}

    private async Task OnShowDeletedChanged(bool newShowDeleted)
    {
   showDeleted = newShowDeleted;
        await LoadCandidates();
    }

    // Random Selection methods
    private void ToggleSelectionPanel()
    {
        showSelectionPanel = !showSelectionPanel;
    }

    // Reports methods
    private void ToggleReportsPanel()
  {
        showReportsPanel = !showReportsPanel;
    }

    private async Task OnReportTypeChanged(string reportType)
    {
   selectedReportType = reportType;
      reportErrorMessage = null;

        if (!string.IsNullOrEmpty(reportType))
        {
            await LoadReportData();
  }
        else
 {
 reportData = null;
        }
    }

    private async Task OnDaysChanged(int days)
    {
        daysSinceLastTest = days;
     if (selectedReportType == "non-selected")
     {
            await LoadReportData();
      }
    }

    private async Task LoadReportData()
  {
        isReportLoading = true;
        reportErrorMessage = null;

        try
        {
            switch (selectedReportType)
            {
    case "all-candidates":
 reportData = await RdsService.GetCandidatesByClientAsync(selectedClient, false);
     break;

                case "non-selected":
         var cutoffDate = DateTime.Now.AddDays(-daysSinceLastTest);
 var allCandidates = await RdsService.GetCandidatesByClientAsync(selectedClient, false);
       reportData = allCandidates
  .Where(c => !c.TestDate.HasValue || c.TestDate.Value < cutoffDate)
     .ToList();
   break;

    case "client-summary":
   await LoadClientSummary();
  break;
    }
        }
        catch (Exception ex)
        {
reportErrorMessage = $"Error loading report data: {ex.Message}";
            Console.WriteLine(ex.ToString());
  }
        finally
    {
         isReportLoading = false;
        }
    }

    private async Task LoadClientSummary()
    {
  try
    {
       var allCandidates = await RdsService.GetCandidatesByClientAsync(selectedClient, true);
var activeCandidates = allCandidates.Where(c => !c.IsDeleted).ToList();
    var deletedCandidates = allCandidates.Where(c => c.IsDeleted).ToList();

          var now = DateTime.Now;
            var firstDayOfMonth = new DateTime(now.Year, now.Month, 1);
   var firstDayOfYear = new DateTime(now.Year, 1, 1);

      summaryStats = new ReportsPanel.ClientSummaryStats
{
                TotalActiveCandidates = activeCandidates.Count,
             TotalDeletedCandidates = deletedCandidates.Count,
          TestedThisMonth = activeCandidates.Count(c => c.TestDate.HasValue && c.TestDate.Value >= firstDayOfMonth),
           TestedThisYear = activeCandidates.Count(c => c.TestDate.HasValue && c.TestDate.Value >= firstDayOfYear),
      NeverTested = activeCandidates.Count(c => !c.TestDate.HasValue),
         AverageDaysSinceLastTest = activeCandidates
        .Where(c => c.TestDate.HasValue)
       .Select(c => (now - c.TestDate!.Value).Days)
   .DefaultIfEmpty(0)
        .Average()
  };

       reportData = activeCandidates;
        }
        catch (Exception ex)
   {
            reportErrorMessage = $"Error loading client summary: {ex.Message}";
 Console.WriteLine(ex.ToString());
        }
    }

    private async Task ExportReportToCsv()
    {
        if (reportData == null || !reportData.Any()) return;

        isReportLoading = true;
   try
        {
       var csv = new System.Text.StringBuilder();

          if (selectedReportType == "client-summary")
         {
                csv.AppendLine($"Client Summary Report - {selectedClient}");
                csv.AppendLine($"Generated: {DateTime.Now:g}");
                csv.AppendLine();
                csv.AppendLine($"Total Active Candidates,{summaryStats.TotalActiveCandidates}");
  csv.AppendLine($"Total Deleted Candidates,{summaryStats.TotalDeletedCandidates}");
         csv.AppendLine($"Tested This Month,{summaryStats.TestedThisMonth}");
    csv.AppendLine($"Tested This Year,{summaryStats.TestedThisYear}");
     csv.AppendLine($"Never Tested,{summaryStats.NeverTested}");
                csv.AppendLine($"Average Days Since Last Test,{summaryStats.AverageDaysSinceLastTest:F1}");
    csv.AppendLine();
            }

            csv.AppendLine("Name,Shift,Client,Last Test Date,Days Since Test,Status");

       foreach (var candidate in reportData)
         {
         var daysSinceTest = candidate.TestDate.HasValue
    ? (DateTime.Now - candidate.TestDate.Value).Days.ToString()
      : "Never";

                csv.AppendLine($"\"{candidate.Name}\",\"{candidate.Shift}\",\"{candidate.ClientMnemonic}\",\"{(candidate.TestDate.HasValue ? candidate.TestDate.Value.ToShortDateString() : "Never")}\",\"{daysSinceTest}\",\"{(candidate.IsDeleted ? "Deleted" : "Active")}\"");
       }

  var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
 var fileName = $"{GetReportFileName()}_{selectedClient}_{timestamp}.csv";

   await JSRuntime.InvokeVoidAsync("fileDownload.downloadFromText",
    csv.ToString(),
    fileName,
   "text/csv");
        }
        catch (Exception ex)
        {
     reportErrorMessage = $"Error exporting CSV: {ex.Message}";
        Console.WriteLine(ex.ToString());
        }
     finally
        {
   isReportLoading = false;
     }
    }

    private async Task GenerateReportPdf()
    {
        if (reportData == null || !reportData.Any()) return;

        isReportLoading = true;
     reportErrorMessage = null;

        try
        {
  var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var fileName = $"{GetReportFileName()}_{selectedClient}_{timestamp}.pdf";

            var document = new Document();
         document.Info.Title = GetReportTitle();
   document.Info.Subject = $"Random Drug Screen Report - {selectedClient}";
  document.Info.Author = AppEnvironment.User;

            var section = document.AddSection();
    section.PageSetup.PageFormat = PageFormat.Letter;
  section.PageSetup.Orientation = Orientation.Portrait;

 var footer = section.Footers.Primary;
            var footerPara = footer.AddParagraph();
            footerPara.Format.Font.Size = 9;
          footerPara.Format.Alignment = ParagraphAlignment.Center;
            footerPara.AddText("Page ");
 footerPara.AddPageField();
        footerPara.AddText(" of ");
            footerPara.AddNumPagesField();
  footerPara.AddText($" | Generated: {DateTime.Now:g}");

          var title = section.AddParagraph();
     title.Format.Font.Size = 16;
            title.Format.Font.Bold = true;
            title.Format.SpaceAfter = "0.5cm";
          title.AddText(GetReportTitle());

            var dateInfo = section.AddParagraph();
        dateInfo.Format.Font.Size = 10;
    dateInfo.Format.SpaceAfter = "0.5cm";
   dateInfo.AddText($"Client: {selectedClient}");

            if (selectedReportType == "client-summary")
            {
         section.AddParagraph($"Total Active Candidates: {summaryStats.TotalActiveCandidates}");
      section.AddParagraph($"Total Deleted Candidates: {summaryStats.TotalDeletedCandidates}");
     section.AddParagraph($"Tested This Month: {summaryStats.TestedThisMonth}");
  section.AddParagraph($"Tested This Year: {summaryStats.TestedThisYear}");
     section.AddParagraph($"Never Tested: {summaryStats.NeverTested}");
       section.AddParagraph($"Average Days Since Last Test: {summaryStats.AverageDaysSinceLastTest:F1}");
          section.AddParagraph();
            }

       var table = section.AddTable();
 table.Borders.Width = 0.75;
        table.Borders.Color = Colors.Black;
            table.Format.KeepTogether = false;

            var column = table.AddColumn("5cm");
            column.Format.Alignment = ParagraphAlignment.Left;
    column = table.AddColumn("2cm");
       column.Format.Alignment = ParagraphAlignment.Left;
       column = table.AddColumn("2cm");
            column.Format.Alignment = ParagraphAlignment.Left;
            column = table.AddColumn("2.5cm");
      column.Format.Alignment = ParagraphAlignment.Left;
    column = table.AddColumn("2.5cm");
    column.Format.Alignment = ParagraphAlignment.Right;
            column = table.AddColumn("2cm");
            column.Format.Alignment = ParagraphAlignment.Center;

       var headerRow = table.AddRow();
            headerRow.HeadingFormat = true;
  headerRow.Format.Font.Bold = true;
    headerRow.Shading.Color = Colors.LightGray;
            headerRow.Borders.Bottom.Width = 2;

     var cell = headerRow.Cells[0];
     cell.AddParagraph("Name");
   cell.Format.Alignment = ParagraphAlignment.Left;
    cell = headerRow.Cells[1];
    cell.AddParagraph("Shift");
      cell.Format.Alignment = ParagraphAlignment.Left;
    cell = headerRow.Cells[2];
  cell.AddParagraph("Client");
            cell.Format.Alignment = ParagraphAlignment.Left;
      cell = headerRow.Cells[3];
         cell.AddParagraph("Last Test Date");
            cell.Format.Alignment = ParagraphAlignment.Left;
        cell = headerRow.Cells[4];
  cell.AddParagraph("Days Since Test");
            cell.Format.Alignment = ParagraphAlignment.Right;
        cell = headerRow.Cells[5];
cell.AddParagraph("Status");
    cell.Format.Alignment = ParagraphAlignment.Center;

            foreach (var candidate in reportData)
    {
              var row = table.AddRow();
          row.Cells[0].AddParagraph(candidate.Name);
       row.Cells[1].AddParagraph(string.IsNullOrEmpty(candidate.Shift) ? "-" : candidate.Shift);
                row.Cells[2].AddParagraph(candidate.ClientMnemonic);
           row.Cells[3].AddParagraph(candidate.TestDate.HasValue ? candidate.TestDate.Value.ToShortDateString() : "Never");

   var daysSinceTest = candidate.TestDate.HasValue
         ? (DateTime.Now - candidate.TestDate.Value).Days.ToString()
       : "Never";
 row.Cells[4].AddParagraph(daysSinceTest);
         row.Cells[4].Format.Alignment = ParagraphAlignment.Right;

                var statusCell = row.Cells[5];
         var statusPara = statusCell.AddParagraph(candidate.IsDeleted ? "Deleted" : "Active");
       statusPara.Format.Alignment = ParagraphAlignment.Center;

       if (reportData.IndexOf(candidate) % 2 == 1)
    {
     row.Shading.Color = new Color(245, 245, 245);
        }
            }

      var pdfRenderer = new PdfDocumentRenderer(true);
       pdfRenderer.Document = document;
            pdfRenderer.RenderDocument();

    using var stream = new System.IO.MemoryStream();
       pdfRenderer.PdfDocument.Save(stream, false);
         var pdfBytes = stream.ToArray();
 var base64 = Convert.ToBase64String(pdfBytes);

            await JSRuntime.InvokeVoidAsync("fileDownload.downloadFromBase64",
          base64,
                fileName,
          "application/pdf");
 }
        catch (Exception ex)
        {
         reportErrorMessage = $"Error generating PDF: {ex.Message}";
Console.WriteLine(ex.ToString());
        }
        finally
{
isReportLoading = false;
        }
    }

    private string GetReportFileName()
    {
        return selectedReportType switch
        {
    "all-candidates" => "AllCandidates",
        "non-selected" => $"NonSelectedCandidates_{daysSinceLastTest}Days",
 "client-summary" => "ClientSummary",
            _ => "Report"
     };
    }

    private string GetReportTitle()
    {
        return selectedReportType switch
        {
            "all-candidates" => $"All Active Candidates - {selectedClient}",
          "non-selected" => $"Non-Selected Candidates ({daysSinceLastTest}+ days) - {selectedClient}",
            "client-summary" => $"Client Summary Report - {selectedClient}",
      _ => "Report"
  };
    }

    private async Task OnSelectionShiftChanged(string newShift)
    {
   selectionShift = newShift;
   await UpdateSelectionAvailableCount();
    }

    private void OnSelectionCountChanged(int newCount)
    {
        selectionCount = newCount;
    }

    private async Task UpdateSelectionAvailableCount()
    {
        try
        {
            if (string.IsNullOrEmpty(selectedClient))
      {
    selectionAvailableCount = 0;
         return;
   }

  List<RandomDrugScreenPerson> availableCandidates;
  if (!string.IsNullOrEmpty(selectionShift))
            {
                availableCandidates = await RdsService.GetCandidatesByClientAsync(selectedClient, false);
             selectionAvailableCount = availableCandidates.Count(c => c.Shift == selectionShift);
            }
   else
            {
                availableCandidates = await RdsService.GetCandidatesByClientAsync(selectedClient, false);
         selectionAvailableCount = availableCandidates.Count;
  }

   if (selectionCount > selectionAvailableCount)
        {
    selectionCount = Math.Max(1, selectionAvailableCount);
            }
        }
        catch (Exception ex)
      {
            Console.WriteLine($"Error updating selection available count: {ex.Message}");
 selectionAvailableCount = 0;
        }
  }

    private bool CanPerformSelection()
    {
  if (string.IsNullOrEmpty(selectedClient))
 {
          selectionValidationMessage = "Please select a client";
        return false;
     }

        if (selectionCount < 1)
        {
      selectionValidationMessage = "Selection count must be at least 1";
            return false;
        }

        if (selectionCount > selectionAvailableCount)
        {
            selectionValidationMessage = $"Selection count ({selectionCount}) exceeds available candidates ({selectionAvailableCount})";
        return false;
        }

  if (selectionAvailableCount == 0)
    {
   selectionValidationMessage = "No candidates available for this client/shift combination";
            return false;
   }

      selectionValidationMessage = null;
        return true;
    }

    private async Task PerformSelection()
  {
        if (!CanPerformSelection()) return;

 isSelectionProcessing = true;
     selectionErrorMessage = null;
 selectedRandomCandidates = null;

    try
        {
    selectedRandomCandidates = await RdsService.SelectRandomCandidatesAsync(
  selectedClient,
    selectionCount,
 string.IsNullOrEmpty(selectionShift) ? null : selectionShift);

    await LoadCandidates();
     selectionCount = 1;
      selectionShift = "";
   await UpdateSelectionAvailableCount();
        }
   catch (Exception ex)
        {
      selectionErrorMessage = $"Error performing selection: {ex.Message}";
            Console.WriteLine(ex.ToString());
        }
        finally
        {
          isSelectionProcessing = false;
        }
    }

    private async Task ExportSelectionResults()
    {
        if (selectedRandomCandidates == null || !selectedRandomCandidates.Any()) return;

        try
        {
var csv = new System.Text.StringBuilder();
 csv.AppendLine("Name,Client,Shift,Previous Test Date,Selection Date");

        foreach (var candidate in selectedRandomCandidates)
      {
    var prevTestDate = candidate.TestDate.HasValue && candidate.TestDate.Value < DateTime.Now.Date
         ? candidate.TestDate.Value.ToShortDateString()
       : "Never";
         csv.AppendLine($"\"{candidate.Name}\",\"{candidate.ClientMnemonic}\",\"{candidate.Shift}\",\"{prevTestDate}\",\"{DateTime.Now.ToShortDateString()}\"");
   }

  var timestamp = DateTime.Now.ToString("yyyyMMdd_HHmmss");
            var fileName = $"RandomSelection_{selectedClient}_{timestamp}.csv";

            await JSRuntime.InvokeVoidAsync("fileDownload.downloadFromText",
          csv.ToString(),
      fileName,
    "text/csv");
        }
        catch (Exception ex)
        {
          errorMessage = $"Error exporting CSV: {ex.Message}";
    Console.WriteLine(ex.ToString());
        }
    }

    private void ClearSelectionResults()
    {
        selectedRandomCandidates = null;
    }

    // Candidate CRUD methods
    private void ShowAddCandidateModal()
    {
   editingCandidate = new RandomDrugScreenPerson
        {
            ClientMnemonic = selectedClient,
            TestDate = null
        };
        errorMessage = null;
  showModal = true;
    }

    private void ShowEditCandidateModal(RandomDrugScreenPerson candidate)
  {
        editingCandidate = new RandomDrugScreenPerson
        {
         Id = candidate.Id,
   Name = candidate.Name,
            ClientMnemonic = candidate.ClientMnemonic,
            Shift = candidate.Shift,
         TestDate = candidate.TestDate,
      IsDeleted = candidate.IsDeleted
        };
        errorMessage = null;
     showModal = true;
    }

    private void CloseModal()
    {
   showModal = false;
        editingCandidate = null;
        errorMessage = null;
    }

    private async Task SaveCandidate(RandomDrugScreenPerson candidate)
    {
        if (candidate == null) return;

        if (string.IsNullOrWhiteSpace(candidate.Name))
        {
  errorMessage = "Name is required";
            return;
        }

        if (string.IsNullOrWhiteSpace(candidate.ClientMnemonic))
        {
errorMessage = "Client is required";
         return;
     }

   isSaving = true;
        errorMessage = null;

        try
        {
            if (candidate.Id > 0)
       {
           await RdsService.UpdateCandidateAsync(candidate);
            }
      else
        {
        await RdsService.AddCandidateAsync(candidate);
         }

            CloseModal();
            await LoadCandidates();
       await UpdateSelectionAvailableCount();
        }
        catch (Exception ex)
        {
      errorMessage = $"Error saving candidate: {ex.Message}";
     Console.WriteLine(ex.ToString());
    }
     finally
        {
        isSaving = false;
 }
    }

    private void ShowDeleteConfirmation(RandomDrugScreenPerson candidate)
    {
        candidateToDelete = candidate;
        showDeleteConfirm = true;
    }

    private void CloseDeleteConfirmation()
    {
      showDeleteConfirm = false;
      candidateToDelete = null;
    }

    private async Task ConfirmDelete()
 {
        if (candidateToDelete == null) return;

        isSaving = true;
        try
        {
  await RdsService.DeleteCandidateAsync(candidateToDelete.Id);
 CloseDeleteConfirmation();
   await LoadCandidates();
            await UpdateSelectionAvailableCount();
        }
    catch (Exception ex)
        {
            errorMessage = $"Error deleting candidate: {ex.Message}";
          Console.WriteLine(ex.ToString());
      }
  finally
        {
            isSaving = false;
        }
  }

private async Task RestoreCandidate(RandomDrugScreenPerson candidate)
    {
        try
        {
            candidate.IsDeleted = false;
            await RdsService.UpdateCandidateAsync(candidate);
            await LoadCandidates();
            await UpdateSelectionAvailableCount();
  }
     catch (Exception ex)
        {
          errorMessage = $"Error restoring candidate: {ex.Message}";
            Console.WriteLine(ex.ToString());
   }
    }
}
