@page "/help"
@page "/help/{DocumentName}"
@using Markdig
@inject NavigationManager NavigationManager
@inject IWebHostEnvironment Environment

<PageTitle>Help & Documentation</PageTitle>

<div class="container-fluid">
 <div class="row">
        <!-- Sidebar Navigation -->
   <div class="col-md-3">
     <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
       <h5 class="mb-0">
   <span class="oi oi-book"></span> Documentation
       </h5>
                </div>
       <div class="list-group list-group-flush">
         <a href="/help/user-guide" 
    class="list-group-item list-group-item-action @(IsActive("user-guide") ? "active" : "")">
       <span class="oi oi-people"></span> User Guide
        </a>
      <a href="/help/quick-reference" 
                class="list-group-item list-group-item-action @(IsActive("quick-reference") ? "active" : "")">
            <span class="oi oi-flash"></span> Quick Reference
 </a>
  <a href="/help/admin-guide" 
              class="list-group-item list-group-item-action @(IsActive("admin-guide") ? "active" : "")">
         <span class="oi oi-cog"></span> Administrator Guide
 </a>
    </div>
       <div class="card-body">
    <h6 class="card-subtitle mb-2 text-muted">Quick Links</h6>
     <div class="d-grid gap-2">
      <a href="/" class="btn btn-sm btn-outline-primary">
<span class="oi oi-home"></span> Home
       </a>
       <a href="/auth-diagnostics" class="btn btn-sm btn-outline-secondary">
      <span class="oi oi-wrench"></span> Diagnostics
            </a>
        </div>
         </div>
        </div>
    </div>

        <!-- Content Area -->
        <div class="col-md-9">
         <div class="card">
      <div class="card-body">
   @if (isLoading)
{
    <div class="text-center p-5">
        <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
          </div>
  <p class="mt-3">Loading documentation...</p>
    </div>
               }
             else if (!string.IsNullOrEmpty(errorMessage))
  {
      <div class="alert alert-danger">
       <h4 class="alert-heading">
         <span class="oi oi-warning"></span> Error Loading Documentation
    </h4>
     <p>@errorMessage</p>
    <hr>
        <p class="mb-0">
          <a href="/help/user-guide" class="alert-link">Try User Guide</a> or 
            <a href="/" class="alert-link">Return to Home</a>
          </p>
      </div>
             }
           else if (string.IsNullOrEmpty(DocumentName))
        {
    <!-- Welcome/Landing Page -->
    <h1>
          <span class="oi oi-book"></span> Help & Documentation
         </h1>
             <p class="lead">Welcome to the Lab Outreach Application help center.</p>

          <div class="row mt-4">
       <div class="col-md-6 mb-3">
     <div class="card h-100 border-primary">
       <div class="card-header bg-primary text-white">
          <h5 class="mb-0">
     <span class="oi oi-people"></span> User Guide
         </h5>
     </div>
                <div class="card-body">
         <p class="card-text">
     Comprehensive guide for end users covering all features and modules.
 </p>
     <ul class="list-unstyled">
      <li><span class="oi oi-check text-success"></span> Getting Started</li>
          <li><span class="oi oi-check text-success"></span> Random Drug Screen Module</li>
     <li><span class="oi oi-check text-success"></span> Client Viewer Module</li>
           <li><span class="oi oi-check text-success"></span> Troubleshooting</li>
 </ul>
             </div>
            <div class="card-footer">
    <a href="/help/user-guide" class="btn btn-primary">
           View User Guide
 </a>
         </div>
      </div>
 </div>

   <div class="col-md-6 mb-3">
           <div class="card h-100 border-info">
      <div class="card-header bg-info text-white">
  <h5 class="mb-0">
          <span class="oi oi-flash"></span> Quick Reference
       </h5>
        </div>
     <div class="card-body">
          <p class="card-text">
     Quick lookup guide for common tasks and shortcuts.
 </p>
        <ul class="list-unstyled">
     <li><span class="oi oi-check text-success"></span> Common Tasks</li>
            <li><span class="oi oi-check text-success"></span> Keyboard Shortcuts</li>
       <li><span class="oi oi-check text-success"></span> Quick Fixes</li>
          <li><span class="oi oi-check text-success"></span> CSV Templates</li>
      </ul>
              </div>
               <div class="card-footer">
          <a href="/help/quick-reference" class="btn btn-info">
   View Quick Reference
           </a>
       </div>
          </div>
   </div>

   <div class="col-md-6 mb-3">
          <div class="card h-100 border-warning">
           <div class="card-header bg-warning">
     <h5 class="mb-0">
       <span class="oi oi-cog"></span> Administrator Guide
     </h5>
            </div>
 <div class="card-body">
         <p class="card-text">
          Technical guide for system administrators.
          </p>
        <ul class="list-unstyled">
           <li><span class="oi oi-check text-success"></span> User Management</li>
         <li><span class="oi oi-check text-success"></span> Permissions</li>
      <li><span class="oi oi-check text-success"></span> System Configuration</li>
             <li><span class="oi oi-check text-success"></span> Maintenance</li>
         </ul>
         </div>
     <div class="card-footer">
       <a href="/help/admin-guide" class="btn btn-warning">
        View Admin Guide
    </a>
     </div>
     </div>
      </div>

        <div class="col-md-6 mb-3">
  <div class="card h-100 border-secondary">
   <div class="card-header bg-secondary text-white">
                  <h5 class="mb-0">
   <span class="oi oi-wrench"></span> Diagnostics
                   </h5>
  </div>
     <div class="card-body">
   <p class="card-text">
           Check your authentication status and permissions.
       </p>
      <ul class="list-unstyled">
         <li><span class="oi oi-check text-success"></span> View Current Permissions</li>
          <li><span class="oi oi-check text-success"></span> Authentication Status</li>
        <li><span class="oi oi-check text-success"></span> Troubleshooting Info</li>
           </ul>
     </div>
         <div class="card-footer">
      <a href="/auth-diagnostics" class="btn btn-secondary">
       View Diagnostics
              </a>
    </div>
       </div>
           </div>
            </div>

    <div class="alert alert-info mt-4">
       <h5 class="alert-heading">
 <span class="oi oi-info"></span> Need More Help?
        </h5>
        <p>
        Contact IT Support for assistance with technical issues or permission requests.
       </p>
           </div>
    }
       else
       {
      <!-- Document Content -->
          <div class="document-content">
    @((MarkupString)documentHtml)
        </div>
}
 </div>
    </div>
   </div>
    </div>
</div>

@code {
    [Parameter]
    public string? DocumentName { get; set; }

    private string documentHtml = string.Empty;
    private string errorMessage = string.Empty;
    private bool isLoading = true;

    protected override async Task OnParametersSetAsync()
    {
        await LoadDocument();
    }

    private async Task LoadDocument()
    {
        isLoading = true;
        errorMessage = string.Empty;
      documentHtml = string.Empty;

  try
  {
   if (string.IsNullOrEmpty(DocumentName))
    {
    isLoading = false;
     return;
}

            var fileName = DocumentName.ToLower() switch
  {
        "user-guide" => "Lab-Outreach-User-Guide.md",
    "quick-reference" => "Lab-Outreach-Quick-Reference.md",
 "admin-guide" => "Lab-Outreach-Administrator-Guide.md",
   _ => null
        };

if (fileName == null)
    {
   errorMessage = $"Document '{DocumentName}' not found.";
        isLoading = false;
  return;
         }

          // Try multiple possible paths
      string? docsPath = null;
  var possiblePaths = new[]
      {
            Path.Combine(Environment.ContentRootPath, "Docs", fileName),
     Path.Combine(AppContext.BaseDirectory, "Docs", fileName),
         Path.Combine(Directory.GetCurrentDirectory(), "Docs", fileName)
 };

 foreach (var path in possiblePaths)
          {
       if (File.Exists(path))
         {
   docsPath = path;
    break;
       }
   }

            if (docsPath == null)
  {
    errorMessage = $"Documentation file '{fileName}' not found. Tried paths:\n";
         foreach (var path in possiblePaths)
  {
       errorMessage += $"  - {path} (exists: {File.Exists(path)})\n";
}
        isLoading = false;
      return;
  }

  var markdown = await File.ReadAllTextAsync(docsPath);
         
 // Configure Markdig pipeline for GitHub-flavored markdown
         var pipeline = new MarkdownPipelineBuilder()
      .UseAdvancedExtensions()
   .Build();

    documentHtml = Markdown.ToHtml(markdown, pipeline);

        // Add Bootstrap classes to HTML elements for better styling
         documentHtml = documentHtml
    .Replace("<table>", "<table class=\"table table-striped table-bordered\">")
 .Replace("<blockquote>", "<blockquote class=\"blockquote border-start border-primary border-5 ps-3 py-2 bg-light\">")
    .Replace("<code>", "<code class=\"bg-light text-danger px-1\">");
        }
 catch (Exception ex)
{
    errorMessage = $"Error loading documentation: {ex.Message}\nStack Trace: {ex.StackTrace}";
      }
    finally
        {
   isLoading = false;
        }
    }

    private bool IsActive(string docName)
    {
        return DocumentName?.Equals(docName, StringComparison.OrdinalIgnoreCase) ?? false;
    }
}
