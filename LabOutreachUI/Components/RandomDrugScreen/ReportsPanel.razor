@using LabBilling.Core.Models

@* Reports Panel Component *@
@if (!string.IsNullOrEmpty(SelectedClient))
{
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white" style="cursor: pointer;" @onclick="TogglePanel">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <span class="oi oi-bar-chart"></span> Reports
                        </h5>
                        <span class="oi @(IsExpanded ? "oi-chevron-top" : "oi-chevron-bottom")"></span>
                    </div>
                </div>

                @if (IsExpanded)
                {
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="reportType" class="form-label">Report Type *</label>
                                <select id="reportType" class="form-select" value="@SelectedReportType" @onchange="HandleReportTypeChanged">
                                    <option value="">-- Select Report --</option>
                                    <option value="all-candidates">All Candidates</option>
                                    <option value="non-selected">Non-Selected Candidates</option>
                                    <option value="client-summary">Client Summary</option>
                                </select>
                            </div>

                            @if (SelectedReportType == "non-selected")
                            {
                                <div class="col-md-6">
                                    <label for="daysSinceTest" class="form-label">Days Since Last Test</label>
                                    <input type="number"
                                           id="daysSinceTest"
                                           class="form-control"
                                           value="@DaysSinceLastTest"
                                           @onchange="HandleDaysChanged"
                                           min="1" />
                                    <small class="text-muted">Show candidates not tested in the last N days</small>
                                </div>
                            }
                        </div>

                        @if (!string.IsNullOrEmpty(ErrorMessage))
                        {
                            <div class="alert alert-danger">
                                <span class="oi oi-x"></span> @ErrorMessage
                            </div>
                        }

                        @if (!string.IsNullOrEmpty(SelectedReportType))
                        {
                            <div class="d-flex gap-2 mb-3">
                                <button class="btn btn-success" @onclick="HandleExportCsv" disabled="@IsProcessing">
                                    @if (IsProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                        <text> Exporting...</text>
                                    }
                                    else
                                    {
                                        <span class="oi oi-data-transfer-download"></span>
                                        <text> Export CSV</text>
                                    }
                                </button>
                                <button class="btn btn-primary" @onclick="HandleGeneratePdf" disabled="@IsProcessing">
                                    @if (IsProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm" role="status"></span>
                                        <text> Generating...</text>
                                    }
                                    else
                                    {
                                        <span class="oi oi-document"></span>
                                        <text> Generate PDF</text>
                                    }
                                </button>
                            </div>
                        }

                        @if (PreviewData != null && PreviewData.Any())
                        {
                            <hr class="my-4" />

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">
                                    <span class="oi oi-document"></span>
                                    @GetReportTitle()
                                </h6>
                                <small class="text-muted">Preview - Use buttons above to export</small>
                            </div>

                            @if (SelectedReportType == "client-summary")
                            {
                                <div class="alert alert-info mb-3">
                                    <strong>Client Summary Statistics</strong>
                                    <dl class="row mb-0 mt-2">
                                        <dt class="col-sm-3">Total Active Candidates:</dt>
                                        <dd class="col-sm-3">@SummaryStats.TotalActiveCandidates</dd>
                                        <dt class="col-sm-3">Total Deleted Candidates:</dt>
                                        <dd class="col-sm-3">@SummaryStats.TotalDeletedCandidates</dd>
                                        <dt class="col-sm-3">Tested This Month:</dt>
                                        <dd class="col-sm-3">@SummaryStats.TestedThisMonth</dd>
                                        <dt class="col-sm-3">Tested This Year:</dt>
                                        <dd class="col-sm-3">@SummaryStats.TestedThisYear</dd>
                                        <dt class="col-sm-3">Never Tested:</dt>
                                        <dd class="col-sm-3">@SummaryStats.NeverTested</dd>
                                        <dt class="col-sm-3">Avg Days Since Test:</dt>
                                        <dd class="col-sm-3">@SummaryStats.AverageDaysSinceLastTest.ToString("F1")</dd>
                                    </dl>
                                </div>
                            }

                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-hover table-sm">
                                    <thead class="sticky-top bg-white">
                                        <tr>
                                            <th>Name</th>
                                            <th>Shift</th>
                                            <th>Client</th>
                                            <th>Last Test Date</th>
                                            <th>Days Since Test</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var candidate in PreviewData)
                                        {
                                            <tr class="@(candidate.IsDeleted ? "table-secondary" : "")">
                                                <td>@candidate.Name</td>
                                                <td>@(string.IsNullOrEmpty(candidate.Shift) ? "-" : candidate.Shift)</td>
                                                <td>@candidate.ClientMnemonic</td>
                                                <td>@(candidate.TestDate.HasValue? candidate.TestDate.Value.ToShortDateString() : "Never")</td>
                                                <td>@GetDaysSinceTest(candidate)</td>
                                                <td>
                                                    @if (candidate.IsDeleted)
                                                    {
                                                        <span class="badge bg-danger">Deleted</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-success">Active</span>
                                                    }
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <div class="mt-3">
                                <p class="text-muted">
                                    Total Records: @PreviewData.Count | Generated: @DateTime.Now.ToString("g")
                                </p>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string SelectedClient { get; set; } = string.Empty;
    [Parameter] public bool IsExpanded { get; set; }
    [Parameter] public string SelectedReportType { get; set; } = string.Empty;
    [Parameter] public int DaysSinceLastTest { get; set; } = 30;
    [Parameter] public bool IsProcessing { get; set; }
    [Parameter] public string? ErrorMessage { get; set; }
    [Parameter] public List<RandomDrugScreenPerson>? PreviewData { get; set; }
    [Parameter] public ClientSummaryStats SummaryStats { get; set; } = new();
    [Parameter] public EventCallback OnTogglePanel { get; set; }
    [Parameter] public EventCallback<string> OnReportTypeChanged { get; set; }
    [Parameter] public EventCallback<int> OnDaysChanged { get; set; }
    [Parameter] public EventCallback OnExportCsv { get; set; }
    [Parameter] public EventCallback OnGeneratePdf { get; set; }

    private async Task TogglePanel()
    {
        await OnTogglePanel.InvokeAsync();
    }

    private async Task HandleReportTypeChanged(ChangeEventArgs e)
    {
        var reportType = e.Value?.ToString() ?? string.Empty;
        await OnReportTypeChanged.InvokeAsync(reportType);
    }

    private async Task HandleDaysChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int days))
        {
            await OnDaysChanged.InvokeAsync(days);
        }
    }

    private async Task HandleExportCsv()
    {
        await OnExportCsv.InvokeAsync();
    }

    private async Task HandleGeneratePdf()
    {
        await OnGeneratePdf.InvokeAsync();
    }

    private string GetReportTitle()
    {
        return SelectedReportType switch
        {
            "all-candidates" => $"All Active Candidates - {SelectedClient}",
            "non-selected" => $"Non-Selected Candidates ({DaysSinceLastTest}+ days) - {SelectedClient}",
            "client-summary" => $"Client Summary Report - {SelectedClient}",
            _ => "Report Preview"
        };
    }

    private string GetDaysSinceTest(RandomDrugScreenPerson candidate)
    {
        if (!candidate.TestDate.HasValue)
            return "Never";

        var days = (DateTime.Now - candidate.TestDate.Value).Days;
        return days.ToString();
    }

    public class ClientSummaryStats
    {
        public int TotalActiveCandidates { get; set; }
        public int TotalDeletedCandidates { get; set; }
        public int TestedThisMonth { get; set; }
        public int TestedThisYear { get; set; }
        public int NeverTested { get; set; }
        public double AverageDaysSinceLastTest { get; set; }
    }
}
