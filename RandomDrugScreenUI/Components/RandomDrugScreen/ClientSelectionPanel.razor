@using LabBilling.Core.Models

@* Client Selection Panel Component *@
<div class="row mb-3">
    <div class="col-md-4">
        <label for="clientSelect" class="form-label">Select Client:</label>
    @if (string.IsNullOrEmpty(SelectedClient))
        {
<AutocompleteInput TItem="Client"
  Items="@Clients"
      SearchProperty="@(c => $"{c.Name} ({c.ClientMnem})")"
      ValueProperty="@(c => c.ClientMnem)"
   ItemTemplate="@clientItemTemplate"
     OnItemSelected="@HandleClientSelected"
        Placeholder="Search by name or mnemonic..."
      MinSearchLength="1"
      MaxResults="15" 
         @ref="clientAutocomplete" />
        }
        else
        {
            <div class="input-group">
      <input type="text" class="form-control" value="@GetSelectedClientDisplay()" readonly />
                <button class="btn btn-outline-secondary" type="button" @onclick="HandleClearSelection" title="Clear selection">
          <span class="oi oi-x"></span>
     </button>
            </div>
            <small class="text-muted">Selected: @SelectedClient</small>
}
    </div>

    <div class="col-md-3">
      <label for="shiftSelect" class="form-label">Filter by Shift:</label>
        <select id="shiftSelect" class="form-select" value="@SelectedShift" @onchange="HandleShiftChanged">
        <option value="">-- All Shifts --</option>
        @foreach (var shift in Shifts)
      {
        <option value="@shift">@shift</option>
         }
   </select>
  </div>

 <div class="col-md-3">
  <label class="form-label d-block">&nbsp;</label>
        <div class="form-check">
<input class="form-check-input" 
   type="checkbox" 
  id="showDeleted" 
       checked="@ShowDeleted" 
          @onchange="HandleShowDeletedChanged">
  <label class="form-check-label" for="showDeleted">
    Show Deleted
            </label>
    </div>
    </div>

    <div class="col-md-2">
        <label class="form-label d-block">&nbsp;</label>
        <button class="btn btn-primary w-100" 
        @onclick="HandleAddNew" 
        disabled="@string.IsNullOrEmpty(SelectedClient)">
            <span class="oi oi-plus"></span> Add New
      </button>
    </div>
</div>

@code {
    [Parameter] public List<Client> Clients { get; set; } = new();
    [Parameter] public string SelectedClient { get; set; } = string.Empty;
    [Parameter] public List<string> Shifts { get; set; } = new();
    [Parameter] public string SelectedShift { get; set; } = string.Empty;
    [Parameter] public bool ShowDeleted { get; set; }
    [Parameter] public EventCallback<Client> OnClientSelected { get; set; }
    [Parameter] public EventCallback OnClearSelection { get; set; }
    [Parameter] public EventCallback<string> OnShiftChanged { get; set; }
    [Parameter] public EventCallback<bool> OnShowDeletedChanged { get; set; }
    [Parameter] public EventCallback OnAddNew { get; set; }

    private AutocompleteInput<Client>? clientAutocomplete;

    // Template for autocomplete items
 private RenderFragment<Client> clientItemTemplate = client => __builder =>
    {
  <div>
        <strong>@client.Name</strong>
            <br />
  <small class="text-muted">@client.ClientMnem</small>
        </div>
 };

    private string GetSelectedClientDisplay()
    {
 var client = Clients.FirstOrDefault(c => c.ClientMnem == SelectedClient);
        return client != null ? $"{client.Name} ({client.ClientMnem})" : SelectedClient;
    }

    private async Task HandleClientSelected(Client client)
    {
        await OnClientSelected.InvokeAsync(client);
    }

    private async Task HandleClearSelection()
    {
        if (clientAutocomplete != null)
{
 clientAutocomplete.Clear();
    }
      await OnClearSelection.InvokeAsync();
    }

    private async Task HandleShiftChanged(ChangeEventArgs e)
    {
        var newShift = e.Value?.ToString() ?? string.Empty;
        await OnShiftChanged.InvokeAsync(newShift);
}

    private async Task HandleShowDeletedChanged(ChangeEventArgs e)
    {
        var showDeleted = (bool)(e.Value ?? false);
        await OnShowDeletedChanged.InvokeAsync(showDeleted);
    }

    private async Task HandleAddNew()
    {
 await OnAddNew.InvokeAsync();
    }
}
