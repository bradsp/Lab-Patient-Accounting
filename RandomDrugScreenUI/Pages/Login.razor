@page "/login"
@using RandomDrugScreenUI.Authentication
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager

<PageTitle>Login - Random Drug Screen</PageTitle>

<div class="container">
    <div class="row justify-content-center mt-5">
<div class="col-md-6 col-lg-4">
      <div class="card shadow">
        <div class="card-body">
   <h3 class="card-title text-center mb-4">
     <span class="oi oi-lock-locked"></span> Login
   </h3>

 @if (!string.IsNullOrEmpty(errorMessage))
          {
 <div class="alert alert-danger" role="alert">
     <span class="oi oi-warning"></span> @errorMessage
     </div>
       }

      <EditForm Model="@loginModel" OnValidSubmit="@HandleLogin">
   <DataAnnotationsValidator />

    <div class="mb-3">
 <label for="username" class="form-label">Username</label>
           <InputText id="username" class="form-control" @bind-Value="loginModel.Username" 
    placeholder="Enter username" disabled="@isLoggingIn" />
  <ValidationMessage For="@(() => loginModel.Username)" />
   </div>

        <div class="mb-3">
   <label for="password" class="form-label">Password</label>
 <InputText id="password" type="password" class="form-control" 
          @bind-Value="loginModel.Password" 
          placeholder="Enter password" disabled="@isLoggingIn" />
 <ValidationMessage For="@(() => loginModel.Password)" />
        </div>

     <div class="d-grid">
      <button type="submit" class="btn btn-primary" disabled="@isLoggingIn">
           @if (isLoggingIn)
   {
     <span class="spinner-border spinner-border-sm" role="status"></span>
     <text> Logging in...</text>
   }
  else
{
  <span class="oi oi-account-login"></span>
       <text> Login</text>
        }
     </button>
  </div>
     </EditForm>

 <div class="mt-3 text-center">
   <small class="text-muted">
Please contact your system administrator if you need access.
      </small>
     </div>
     </div>
         </div>
        </div>
 </div>
</div>

@code {
  [Parameter]
    [SupplyParameterFromQuery(Name = "returnUrl")]
public string? ReturnUrl { get; set; }

  private LoginModel loginModel = new();
    private string? errorMessage;
    private bool isLoggingIn = false;

 private async Task HandleLogin()
    {
   isLoggingIn = true;
   errorMessage = null;

        try
 {
 var (success, error) = await AuthStateProvider.Authenticate(
   loginModel.Username, 
    loginModel.Password);

    if (success)
            {
    // Redirect to return URL or home page
    var returnUrl = string.IsNullOrEmpty(ReturnUrl) ? "/" : ReturnUrl;
     NavigationManager.NavigateTo(returnUrl);
   }
        else
 {
       errorMessage = error;
  }
    }
      catch (Exception ex)
   {
   errorMessage = $"An error occurred during login: {ex.Message}";
        }
        finally
        {
 isLoggingIn = false;
     }
    }

    private class LoginModel
    {
        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Username is required")]
        public string Username { get; set; } = string.Empty;

        [System.ComponentModel.DataAnnotations.Required(ErrorMessage = "Password is required")]
     public string Password { get; set; } = string.Empty;
    }
}
