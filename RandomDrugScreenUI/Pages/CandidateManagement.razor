@page "/candidates"
@inject IRandomDrugScreenService RdsService
@inject DictionaryService DictionaryService
@inject IJSRuntime JSRuntime
@inject LabBilling.Core.DataAccess.IAppEnvironment AppEnvironment
@inject LabBilling.Core.UnitOfWork.IUnitOfWork UnitOfWork
@inject NavigationManager NavigationManager

<PageTitle>Candidate Management - Random Drug Screen</PageTitle>

<h3>Candidate Management</h3>

<div class="row mb-3">
  <div class="col-md-4">
        <label for="clientSelect" class="form-label">Select Client:</label>
        @if (string.IsNullOrEmpty(selectedClient))
   {
      <AutocompleteInput TItem="Client"
      Items="@clients"
                SearchProperty="@(c => $"{c.Name} ({c.ClientMnem})")"
          ValueProperty="@(c => c.ClientMnem)"
  ItemTemplate="@clientItemTemplate"
      OnItemSelected="@OnClientSelected"
     Placeholder="Search by name or mnemonic..."
      MinSearchLength="1"
                MaxResults="15" 
             @ref="clientAutocomplete" />
   }
        else
        {
          <div class="input-group">
         <input type="text" class="form-control" value="@GetSelectedClientDisplay()" readonly />
        <button class="btn btn-outline-secondary" type="button" @onclick="ClearClientSelection" title="Clear selection">
           <span class="oi oi-x"></span>
                </button>
         </div>
          <small class="text-muted">Selected: @selectedClient</small>
}
    </div>
    <div class="col-md-3">
    <label for="shiftSelect" class="form-label">Filter by Shift:</label>
 <select id="shiftSelect" class="form-select" value="@selectedShift" @onchange="OnShiftChanged">
  <option value="">-- All Shifts --</option>
       @foreach (var shift in shifts)
         {
<option value="@shift">@shift</option>
        }
   </select>
    </div>
    <div class="col-md-3">
  <label class="form-label d-block">&nbsp;</label>
   <div class="form-check">
       <input class="form-check-input" type="checkbox" id="showDeleted" checked="@showDeleted" @onchange="OnShowDeletedChanged">
     <label class="form-check-label" for="showDeleted">
    Show Deleted
    </label>
    </div>
    </div>
    <div class="col-md-2">
   <label class="form-label d-block">&nbsp;</label>
  <button class="btn btn-primary w-100" @onclick="ShowAddCandidateModal" disabled="@string.IsNullOrEmpty(selectedClient)">
   <span class="oi oi-plus"></span> Add New
  </button>
    </div>
</div>

<!-- Random Selection Panel -->
@if (!string.IsNullOrEmpty(selectedClient))
{
    <div class="row mb-3">
  <div class="col-md-12">
      <div class="card border-primary">
  <div class="card-header bg-primary text-white" style="cursor: pointer;" @onclick="ToggleSelectionPanel">
    <div class="d-flex justify-content-between align-items-center">
    <h5 class="mb-0">
   <span class="oi oi-random"></span> Random Selection
     </h5>
       <span class="oi @(showSelectionPanel ? "oi-chevron-top" : "oi-chevron-bottom")"></span>
      </div>
  </div>
  @if (showSelectionPanel)
      {
         <div class="card-body">
  <div class="row">
<div class="col-md-8">
   <div class="row mb-3">
 <div class="col-md-6">
       <label for="selectionShift" class="form-label">Shift Filter (Optional)</label>
 <select id="selectionShift" class="form-select" value="@selectionShift" @onchange="OnSelectionShiftChanged">
 <option value="">-- All Shifts --</option>
    @foreach (var shift in shifts)
      {
      <option value="@shift">@shift</option>
    }
      </select>
  </div>
  <div class="col-md-6">
 <label for="selectionCount" class="form-label">Number to Select *</label>
      <input type="number" id="selectionCount" class="form-control" @bind="selectionCount" min="1" max="@selectionAvailableCount" />
            <small class="text-muted">Available: @selectionAvailableCount</small>
   </div>
          </div>

   @if (selectionValidationMessage != null)
   {
          <div class="alert alert-warning">
   <span class="oi oi-warning"></span> @selectionValidationMessage
     </div>
}

     @if (selectionErrorMessage != null)
      {
             <div class="alert alert-danger">
<span class="oi oi-x"></span> @selectionErrorMessage
        </div>
      }

          <div class="d-grid gap-2">
  <button class="btn btn-primary btn-lg" @onclick="PerformSelection" disabled="@(isSelectionProcessing || !CanPerformSelection())">
      @if (isSelectionProcessing)
    {
   <span class="spinner-border spinner-border-sm" role="status"></span>
      <text> Generating Selection...</text>
       }
 else
          {
      <span class="oi oi-random"></span>
   <text> Generate Random Selection</text>
      }
           </button>
           </div>
     </div>

           <div class="col-md-4">
   <div class="card bg-light">
       <div class="card-body">
          <h6 class="card-title">Selection Info</h6>
   <dl class="mb-0">
     <dt>Client</dt>
    <dd>@selectedClient</dd>
    <dt>Shift Filter</dt>
         <dd>@(string.IsNullOrEmpty(selectionShift) ? "All shifts" : selectionShift)</dd>
             <dt>Selection Count</dt>
      <dd>@selectionCount</dd>
         <dt>Available</dt>
      <dd>@selectionAvailableCount</dd>
      </dl>
       </div>
   </div>
      </div>
 </div>
     </div>
     }
     </div>
        </div>
    </div>
}

<!-- Selection Results -->
@if (selectedRandomCandidates != null && selectedRandomCandidates.Any())
{
    <div class="row mb-3">
        <div class="col-md-12">
   <div class="card border-success">
     <div class="card-header bg-success text-white">
        <h5 class="mb-0"><span class="oi oi-check"></span> Selection Results - @selectedRandomCandidates.Count Candidate(s) Selected</h5>
        </div>
     <div class="card-body">
   <div class="alert alert-success">
  <strong>Success!</strong> @selectedRandomCandidates.Count candidate(s) have been randomly selected and their test dates have been updated.
    </div>

        <div class="table-responsive">
         <table class="table table-striped">
       <thead>
    <tr>
    <th>#</th>
    <th>Name</th>
      <th>Shift</th>
        <th>Previous Test Date</th>
<th>New Test Date</th>
   </tr>
    </thead>
        <tbody>
       @for (int i = 0; i < selectedRandomCandidates.Count; i++)
   {
  var candidate = selectedRandomCandidates[i];
               <tr>
      <td>@(i + 1)</td>
  <td><strong>@candidate.Name</strong></td>
            <td>@(string.IsNullOrEmpty(candidate.Shift) ? "-" : candidate.Shift)</td>
     <td>@(candidate.TestDate.HasValue && candidate.TestDate.Value < DateTime.Now.Date ? candidate.TestDate.Value.ToShortDateString() : "Never")</td>
   <td><span class="badge bg-success">@DateTime.Now.ToShortDateString()</span></td>
       </tr>
    }
</tbody>
         </table>
 </div>

  <div class="d-flex gap-2">
   <button class="btn btn-primary" @onclick="ExportSelectionResults">
    <span class="oi oi-data-transfer-download"></span> Export to CSV
       </button>
  <button class="btn btn-secondary" @onclick="ClearSelectionResults">
     <span class="oi oi-x"></span> Clear Results
     </button>
  </div>
 </div>
   </div>
  </div>
    </div>
}

@if (isLoading)
{
    <div class="text-center">
     <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
     </div>
     <p>Loading candidates...</p>
  </div>
}
else if (string.IsNullOrEmpty(selectedClient))
{
  <div class="alert alert-info">
    <span class="oi oi-info"></span> Please select a client to view candidates.
    </div>
}
else if (candidates.Any())
{
    <div class="row mb-2">
      <div class="col">
     <p class="text-muted">
        Showing @candidates.Count candidate(s) for client @selectedClient
  </p>
 </div>
    </div>

    <div class="table-responsive">
 <table class="table table-striped table-hover">
       <thead>
 <tr>
     <th>Name</th>
 <th>Client</th>
  <th>Shift</th>
    <th>Last Test Date</th>
     <th>Status</th>
<th>Actions</th>
  </tr>
     </thead>
      <tbody>
    @foreach (var candidate in candidates)
       {
    <tr class="@(candidate.IsDeleted ? "table-secondary" : "")">
 <td>@candidate.Name</td>
 <td>@candidate.ClientMnemonic</td>
      <td>@(string.IsNullOrEmpty(candidate.Shift) ? "-" : candidate.Shift)</td>
    <td>@(candidate.TestDate.HasValue ? candidate.TestDate.Value.ToShortDateString() : "Never")</td>
   <td>
      @if (candidate.IsDeleted)
     {
  <span class="badge bg-danger">Deleted</span>
       }
           else
    {
       <span class="badge bg-success">Active</span>
         }
   </td>
  <td>
   <button class="btn btn-sm btn-primary" @onclick="() => ShowEditCandidateModal(candidate)" disabled="@candidate.IsDeleted">
  <span class="oi oi-pencil"></span> Edit
  </button>
  @if (candidate.IsDeleted)
  {
      <button class="btn btn-sm btn-success" @onclick="() => RestoreCandidate(candidate)">
           <span class="oi oi-action-undo"></span> Restore
   </button>
 }
        else
    {
    <button class="btn btn-sm btn-danger" @onclick="() => ShowDeleteConfirmation(candidate)">
     <span class="oi oi-trash"></span> Delete
        </button>
    }
   </td>
     </tr>
         }
   </tbody>
        </table>
 </div>
}
else
{
    <div class="alert alert-info">
        <span class="oi oi-info"></span> No candidates found for client @selectedClient. Add a new candidate to get started.
  </div>
}

<!-- Add/Edit Modal -->
@if (showModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
       <div class="modal-header">
        <h5 class="modal-title">@(editingCandidate?.Id > 0 ? "Edit" : "Add") Candidate</h5>
         <button type="button" class="btn-close" @onclick="CloseModal"></button>
       </div>
        <div class="modal-body">
           <EditForm Model="editingCandidate" OnValidSubmit="SaveCandidate">
         <DataAnnotationsValidator />
          <ValidationSummary class="text-danger" />

        <div class="mb-3">
     <label for="candidateName" class="form-label">Name *</label>
      <InputText id="candidateName" class="form-control" @bind-Value="editingCandidate.Name" />
    </div>

            <div class="mb-3">
         <label for="candidateClient" class="form-label">Client *</label>
        <AutocompleteInput TItem="Client"
 Items="@clients"
          SearchProperty="@(c => $"{c.Name} ({c.ClientMnem})")"
            ValueProperty="@(c => c.ClientMnem)"
  ItemTemplate="@clientItemTemplate"
        OnItemSelected="@((client) => { if (editingCandidate != null) editingCandidate.ClientMnemonic = client.ClientMnem; })"
Placeholder="Search by name or mnemonic..."
    MinSearchLength="1"
 MaxResults="10" />
   </div>

      <div class="mb-3">
              <label for="candidateShift" class="form-label">Shift</label>
             <InputText id="candidateShift" class="form-control" @bind-Value="editingCandidate.Shift" placeholder="Optional" />
 </div>

     @if (errorMessage != null)
   {
        <div class="alert alert-danger">@errorMessage</div>
         }

  <div class="modal-footer">
  <button type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
    <button type="submit" class="btn btn-primary" disabled="@isSaving">
          @if (isSaving)
          {
               <span class="spinner-border spinner-border-sm" role="status"></span>
         <text> Saving...</text>
          }
 else
    {
       <span class="oi oi-check"></span>
                 <text> Save</text>
   }
           </button>
      </div>
           </EditForm>
    </div>
       </div>
        </div>
    </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteConfirm)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog">
 <div class="modal-content">
   <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
          <button type="button" class="btn-close" @onclick="CloseDeleteConfirmation"></button>
      </div>
      <div class="modal-body">
          <p>Are you sure you want to delete candidate <strong>@candidateToDelete?.Name</strong>?</p>
 <p class="text-muted">This will mark the candidate as deleted. You can restore them later if needed.</p>
          </div>
      <div class="modal-footer">
      <button type="button" class="btn btn-secondary" @onclick="CloseDeleteConfirmation">Cancel</button>
     <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isSaving">
          @if (isSaving)
          {
  <span class="spinner-border spinner-border-sm" role="status"></span>
       <text> Deleting...</text>
       }
         else
         {
           <span class="oi oi-trash"></span>
 <text> Delete</text>
        }
   </button>
             </div>
            </div>
        </div>
    </div>
}

@code {
  private List<RandomDrugScreenPerson> candidates = new();
    private List<Client> clients = new();
    private List<string> shifts = new();
    
    private string selectedClient = "";
    private string selectedShift = "";
    private bool showDeleted = false;
    private bool isLoading = true;
    private bool isSaving = false;
    
    private bool showModal = false;
    private bool showDeleteConfirm = false;
    private RandomDrugScreenPerson? editingCandidate;
    private RandomDrugScreenPerson? candidateToDelete;
    private string? errorMessage;

    // Random Selection fields
 private bool showSelectionPanel = false;
    private string selectionShift = "";
    private int selectionCount = 1;
    private int selectionAvailableCount = 0;
    private bool isSelectionProcessing = false;
    private string? selectionValidationMessage;
    private string? selectionErrorMessage;
    private List<RandomDrugScreenPerson>? selectedRandomCandidates;

    // Autocomplete reference
    private AutocompleteInput<Client>? clientAutocomplete;

    // Template for autocomplete items
    private RenderFragment<Client> clientItemTemplate = client => __builder =>
    {
     <div>
<strong>@client.Name</strong>
   <br />
 <small class="text-muted">@client.ClientMnem</small>
  </div>
    };

    protected override async Task OnInitializedAsync()
    {
        try
 {
 await LoadClients();
       
       // Check for client query parameter
    var uri = new Uri(NavigationManager.Uri);
       var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
       var clientParam = query["client"];
     
    if (!string.IsNullOrEmpty(clientParam))
       {
    // Pre-select the client from query parameter
     var client = clients.FirstOrDefault(c => c.ClientMnem == clientParam);
  if (client != null)
     {
       await OnClientSelected(client);
  }
     }
  }
     catch (Exception ex)
 {
  errorMessage = $"Error loading data: {ex.Message}";
 Console.WriteLine(ex.ToString());
 }
      finally
        {
   isLoading = false;
    }
    }

  private async Task LoadClients()
    {
try
   {
 clients = await DictionaryService.GetAllClientsAsync(UnitOfWork, false);
  }
    catch (Exception ex)
{
         Console.WriteLine($"Error loading clients: {ex.Message}");
   clients = new List<Client>();
}
    }

    private async Task LoadShifts()
    {
      try
    {
     if (!string.IsNullOrEmpty(selectedClient))
    {
  shifts = await RdsService.GetDistinctShiftsAsync(selectedClient);
   }
          else
    {
      shifts = await RdsService.GetDistinctShiftsAsync();
 }
   }
        catch (Exception ex)
     {
   Console.WriteLine($"Error loading shifts: {ex.Message}");
      shifts = new List<string>();
        }
    }

    private async Task LoadCandidates()
  {
   isLoading = true;
      try
     {
         if (!string.IsNullOrEmpty(selectedClient))
      {
      if (!string.IsNullOrEmpty(selectedShift))
  {
      // Filter by client and shift
       candidates = await RdsService.GetCandidatesByClientAsync(selectedClient, showDeleted);
  candidates = candidates.Where(c => c.Shift == selectedShift).ToList();
      }
   else
       {
  candidates = await RdsService.GetCandidatesByClientAsync(selectedClient, showDeleted);
    }
        }
   else
     {
      candidates = await RdsService.GetAllCandidatesAsync(showDeleted);
  }
  }
  catch (Exception ex)
  {
  errorMessage = $"Error loading candidates: {ex.Message}";
       Console.WriteLine(ex.ToString());
 candidates = new List<RandomDrugScreenPerson>();
        }
        finally
      {
    isLoading = false;
     }
    }

    private async Task ClearClientSelection()
    {
 selectedClient = "";
        selectedShift = "";
     candidates = new List<RandomDrugScreenPerson>();
        shifts = new List<string>();
        selectionAvailableCount = 0;
        selectedRandomCandidates = null;
        
        if (clientAutocomplete != null)
        {
            clientAutocomplete.Clear();
}
        
        StateHasChanged();
        await Task.CompletedTask;
    }

    private string GetSelectedClientDisplay()
    {
        var client = clients.FirstOrDefault(c => c.ClientMnem == selectedClient);
   return client != null ? $"{client.Name} ({client.ClientMnem})" : selectedClient;
    }

    private async Task OnClientSelected(Client client)
    {
  selectedClient = client?.ClientMnem ?? "";
        selectedShift = "";
        await LoadShifts();
  await LoadCandidates();
        await UpdateSelectionAvailableCount();
    }

    private async Task OnClientChanged(ChangeEventArgs e)
    {
        selectedClient = e.Value?.ToString() ?? "";
        selectedShift = ""; // Reset shift when client changes
  await LoadShifts();
 await LoadCandidates();
  }

    private async Task OnShiftChanged(ChangeEventArgs e)
    {
  selectedShift = e.Value?.ToString() ?? "";
        await LoadCandidates();
    }

    private async Task OnShowDeletedChanged(ChangeEventArgs e)
    {
        showDeleted = (bool)(e.Value ?? false);
  await LoadCandidates();
  }

    private async Task UpdateSelectionAvailableCount()
    {
      try
        {
     if (string.IsNullOrEmpty(selectedClient))
  {
       selectionAvailableCount = 0;
return;
     }

   List<RandomDrugScreenPerson> availableCandidates;
       if (!string.IsNullOrEmpty(selectionShift))
      {
     availableCandidates = await RdsService.GetCandidatesByClientAsync(selectedClient, false);
            selectionAvailableCount = availableCandidates.Count(c => c.Shift == selectionShift);
}
else
    {
 availableCandidates = await RdsService.GetCandidatesByClientAsync(selectedClient, false);
    selectionAvailableCount = availableCandidates.Count;
    }

     // Adjust selection count if it exceeds available
    if (selectionCount > selectionAvailableCount)
      {
     selectionCount = Math.Max(1, selectionAvailableCount);
    }
   }
     catch (Exception ex)
 {
   Console.WriteLine($"Error updating selection available count: {ex.Message}");
   selectionAvailableCount = 0;
 }
    await Task.CompletedTask;
    }

    private async Task OnSelectionShiftChanged(ChangeEventArgs e)
    {
        selectionShift = e.Value?.ToString() ?? "";
  await UpdateSelectionAvailableCount();
    }

    private bool CanPerformSelection()
 {
        if (string.IsNullOrEmpty(selectedClient))
   {
            selectionValidationMessage = "Please select a client";
    return false;
 }

        if (selectionCount < 1)
  {
   selectionValidationMessage = "Selection count must be at least 1";
       return false;
        }

        if (selectionCount > selectionAvailableCount)
   {
       selectionValidationMessage = $"Selection count ({selectionCount}) exceeds available candidates ({selectionAvailableCount})";
    return false;
        }

        if (selectionAvailableCount == 0)
  {
      selectionValidationMessage = "No candidates available for this client/shift combination";
            return false;
        }

        selectionValidationMessage = null;
        return true;
    }

    private async Task PerformSelection()
    {
        if (!CanPerformSelection()) return;

   isSelectionProcessing = true;
  selectionErrorMessage = null;
        selectedRandomCandidates = null;

        try
      {
      selectedRandomCandidates = await RdsService.SelectRandomCandidatesAsync(
         selectedClient,
     selectionCount,
     string.IsNullOrEmpty(selectionShift) ? null : selectionShift);

    // Refresh the candidates list to show updated test dates
      await LoadCandidates();
       
            // Reset selection panel
 selectionCount = 1;
         selectionShift = "";
     await UpdateSelectionAvailableCount();
        }
        catch (Exception ex)
        {
     selectionErrorMessage = $"Error performing selection: {ex.Message}";
    Console.WriteLine(ex.ToString());
 }
        finally
   {
       isSelectionProcessing = false;
        }
    }

    private void ExportSelectionResults()
    {
if (selectedRandomCandidates == null || !selectedRandomCandidates.Any()) return;

 var csv = new System.Text.StringBuilder();
  csv.AppendLine("Name,Client,Shift,Previous Test Date,Selection Date");

   foreach (var candidate in selectedRandomCandidates)
 {
            var prevTestDate = candidate.TestDate.HasValue && candidate.TestDate.Value < DateTime.Now.Date 
         ? candidate.TestDate.Value.ToShortDateString() 
  : "Never";
            csv.AppendLine($"\"{candidate.Name}\",\"{candidate.ClientMnemonic}\",\"{candidate.Shift}\",\"{prevTestDate}\",\"{DateTime.Now.ToShortDateString()}\"");
      }

        // TODO: Implement file download using JS Interop
        Console.WriteLine("CSV Export:");
  Console.WriteLine(csv.ToString());
    }

    private void ClearSelectionResults()
    {
    selectedRandomCandidates = null;
    }

    // Existing Candidate Management Methods
    private void ShowAddCandidateModal()
    {
        editingCandidate = new RandomDrugScreenPerson 
        { 
    ClientMnemonic = selectedClient,
   TestDate = null // Use null instead of DateTime.MinValue
    };
        errorMessage = null;
        showModal = true;
  }

 private void ShowEditCandidateModal(RandomDrugScreenPerson candidate)
    {
        editingCandidate = new RandomDrugScreenPerson
  {
            Id = candidate.Id,
            Name = candidate.Name,
 ClientMnemonic = candidate.ClientMnemonic,
 Shift = candidate.Shift,
     TestDate = candidate.TestDate,
       IsDeleted = candidate.IsDeleted
        };
        errorMessage = null;
  showModal = true;
  }

    private void CloseModal()
    {
   showModal = false;
  editingCandidate = null;
      errorMessage = null;
    }

    private async Task SaveCandidate()
    {
    if (editingCandidate == null) return;

    if (string.IsNullOrWhiteSpace(editingCandidate.Name))
        {
   errorMessage = "Name is required";
      return;
      }

        if (string.IsNullOrWhiteSpace(editingCandidate.ClientMnemonic))
  {
      errorMessage = "Client is required";
    return;
        }

        isSaving = true;
   errorMessage = null;

      try
  {
  if (editingCandidate.Id > 0)
  {
   await RdsService.UpdateCandidateAsync(editingCandidate);
    }
  else
   {
   await RdsService.AddCandidateAsync(editingCandidate);
}

      CloseModal();
await LoadCandidates();
  await UpdateSelectionAvailableCount();
  }
      catch (Exception ex)
     {
      errorMessage = $"Error saving candidate: {ex.Message}";
      Console.WriteLine(ex.ToString());
  }
        finally
        {
  isSaving = false;
        }
    }

    private void ShowDeleteConfirmation(RandomDrugScreenPerson candidate)
 {
        candidateToDelete = candidate;
        showDeleteConfirm = true;
    }

private void CloseDeleteConfirmation()
    {
        showDeleteConfirm = false;
 candidateToDelete = null;
    }

    private async Task ConfirmDelete()
    {
        if (candidateToDelete == null) return;

      isSaving = true;
        try
        {
       await RdsService.DeleteCandidateAsync(candidateToDelete.Id);
            CloseDeleteConfirmation();
        await LoadCandidates();
         await UpdateSelectionAvailableCount();
        }
      catch (Exception ex)
        {
      errorMessage = $"Error deleting candidate: {ex.Message}";
       Console.WriteLine(ex.ToString());
        }
     finally
  {
        isSaving = false;
    }
    }

    private async Task RestoreCandidate(RandomDrugScreenPerson candidate)
    {
    try
     {
 candidate.IsDeleted = false;
            await RdsService.UpdateCandidateAsync(candidate);
  await LoadCandidates();
            await UpdateSelectionAvailableCount();
     }
     catch (Exception ex)
   {
      errorMessage = $"Error restoring candidate: {ex.Message}";
     Console.WriteLine(ex.ToString());
        }
    }

    private void ToggleSelectionPanel()
  {
     showSelectionPanel = !showSelectionPanel;
    }
}
