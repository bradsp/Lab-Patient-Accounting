@using RandomDrugScreenUI.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager
@implements IDisposable

<CascadingAuthenticationState>
    @if (isCheckingAuth)
    {
   <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
      <div class="text-center">
       <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
    <span class="visually-hidden">Authenticating...</span>
       </div>
          <p class="mt-3">Authenticating...</p>
 </div>
</div>
    }
    else
    {
      @ChildContent
    }
</CascadingAuthenticationState>

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private bool isCheckingAuth = true;

    protected override async Task OnInitializedAsync()
    {
   try
 {
       var authMode = Configuration.GetValue<string>("AppSettings:AuthenticationMode") ?? "Integrated";
 var currentUri = new Uri(NavigationManager.Uri);
   var isLoginPage = currentUri.AbsolutePath.Equals("/login", StringComparison.OrdinalIgnoreCase);

     // Check current authentication state
   var authState = await AuthStateProvider.GetAuthenticationStateAsync();
      var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

          // If using integrated auth and not authenticated, try to auto-login
      if (authMode.Equals("Integrated", StringComparison.OrdinalIgnoreCase) && !isAuthenticated)
            {
var windowsUsername = Environment.UserName;
    var success = await AuthStateProvider.AuthenticateIntegrated(windowsUsername);

       if (!success && !isLoginPage)
    {
     // Windows auth failed, redirect to login page
      NavigationManager.NavigateTo("/login");
        }
    }
            else if (!isAuthenticated && !isLoginPage)
     {
     // SQL auth mode and not authenticated, redirect to login
       NavigationManager.NavigateTo("/login");
     }
   }
        catch (Exception ex)
      {
     Console.WriteLine($"Error during authentication check: {ex.Message}");
        }
        finally
      {
   isCheckingAuth = false;
  StateHasChanged();
     }
    }

    public void Dispose()
    {
  // Cleanup if needed
    }
}
