@using RandomDrugScreenUI.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@inject CustomAuthenticationStateProvider AuthStateProvider
@inject IConfiguration Configuration
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor
@implements IDisposable

<CascadingAuthenticationState>
    @if (isCheckingAuth)
    {
        <div class="d-flex justify-content-center align-items-center" style="height: 100vh;">
            <div class="text-center">
 <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
       <span class="visually-hidden">Authenticating...</span>
            </div>
            <p class="mt-3">Authenticating...</p>
            </div>
      </div>
    }
    else
    {
    @ChildContent
    }
</CascadingAuthenticationState>

@code {
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    private bool isCheckingAuth = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
  {
       await CheckAndAuthenticateUser();
        }
 }

    private async Task CheckAndAuthenticateUser()
    {
        try
        {
    var authMode = Configuration.GetValue<string>("AppSettings:AuthenticationMode") ?? "Integrated";
var currentUri = new Uri(NavigationManager.Uri);
     var isLoginPage = currentUri.AbsolutePath.Equals("/login", StringComparison.OrdinalIgnoreCase);

 Console.WriteLine($"AuthenticationWrapper: Current path: {currentUri.AbsolutePath}");
            Console.WriteLine($"AuthenticationWrapper: Auth mode: {authMode}");

         // Check current authentication state
  var authState = await AuthStateProvider.GetAuthenticationStateAsync();
    var isAuthenticated = authState.User.Identity?.IsAuthenticated ?? false;

         Console.WriteLine($"AuthenticationWrapper: IsAuthenticated: {isAuthenticated}");

            // If using integrated auth and not authenticated, try to auto-login
         if (authMode.Equals("Integrated", StringComparison.OrdinalIgnoreCase) && !isAuthenticated)
  {
     // Get Windows user from IIS authentication
     var httpContext = HttpContextAccessor.HttpContext;
           var windowsUsername = httpContext?.User?.Identity?.Name;
  
  Console.WriteLine($"AuthenticationWrapper: Integrated auth mode detected");
        Console.WriteLine($"AuthenticationWrapper: Windows username from IIS: {windowsUsername ?? "NULL"}");
    
         if (!string.IsNullOrEmpty(windowsUsername))
      {
         var success = await AuthStateProvider.AuthenticateIntegrated(windowsUsername);
     Console.WriteLine($"AuthenticationWrapper: AuthenticateIntegrated result: {success}");

    if (success)
 {
    // Authentication succeeded, refresh to update UI
       Console.WriteLine($"AuthenticationWrapper: Auth succeeded, reloading state");
     isCheckingAuth = false;
       StateHasChanged();
  
              // If we're on the login page, redirect to home
   if (isLoginPage)
         {
  Console.WriteLine($"AuthenticationWrapper: Redirecting from /login to /");
        NavigationManager.NavigateTo("/", forceLoad: true);
    }
        return;
     }
          else if (!isLoginPage)
{
              // Windows auth failed, redirect to login page
           Console.WriteLine($"AuthenticationWrapper: Auth failed, redirecting to /login");
  isCheckingAuth = false;
     StateHasChanged();
          NavigationManager.NavigateTo("/login");
   return;
          }
                }
   else if (!isLoginPage)
      {
       // No Windows user available, redirect to login
   Console.WriteLine($"AuthenticationWrapper: No Windows user, redirecting to /login");
           isCheckingAuth = false;
           StateHasChanged();
     NavigationManager.NavigateTo("/login");
         return;
                }
            }
            else if (!isAuthenticated && !isLoginPage)
            {
    // SQL auth mode and not authenticated, redirect to login
  Console.WriteLine($"AuthenticationWrapper: Not authenticated, redirecting to /login");
       isCheckingAuth = false;
      StateHasChanged();
             NavigationManager.NavigateTo("/login");
    return;
  }
            else
   {
        Console.WriteLine($"AuthenticationWrapper: Already authenticated or on login page");
          }
        }
        catch (Exception ex)
        {
      Console.WriteLine($"AuthenticationWrapper: Error during authentication check: {ex.Message}");
        Console.WriteLine($"AuthenticationWrapper: Stack trace: {ex.StackTrace}");
        }
        finally
        {
    isCheckingAuth = false;
            StateHasChanged();
        }
    }

public void Dispose()
    {
    // Cleanup if needed
    }
}
